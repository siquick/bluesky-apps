<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlueskyFM • Live Music Feed</title>
    <meta name="title" content="Bluesky FM • Live Music Feed" />
    <meta name="description" content="Discover what music the Bluesky community is sharing in real-time." />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="hero">
        <div class="hero-background">
          <div class="gradient-orb"></div>
          <div class="gradient-orb"></div>
          <div class="gradient-orb"></div>
        </div>
        <div class="hero-content">
          <h1>
            <span class="gradient-text">Bluesky</span>
            <span class="gradient-text accent">FM</span>
          </h1>
          <p class="hero-description">
            Discover music shared across the Bluesky network in real-time. We monitor the firehose for Spotify links and
            instantly create a live feed of tracks, albums, and playlists being discussed right now.
          </p>
          <p class="hero-credits">
            Built by
            <a href="https://bsky.app/profile/siquick.com" target="_blank" rel="noopener noreferrer">Si Quick</a> with
            inspiration from
            <a href="https://bsky.app/profile/simonwillison.net" target="_blank" rel="noopener noreferrer"
              >Simon Willison</a
            >
          </p>
        </div>
      </div>

      <div class="status-bar glass">
        <div class="status-group">
          <div class="status disconnected">
            <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
                stroke="currentColor"
                stroke-width="2"
              />
              <path
                class="pulse-circle"
                d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
                stroke="currentColor"
                stroke-width="2"
              />
            </svg>
            <span class="status-text">Not Connected</span>
          </div>
          <div class="status-pills">
            <div class="pill">
              <span class="pill-label">Posts scanned</span>
              <span class="pill-value" id="post-count">0</span>
            </div>
            <div class="pill">
              <span class="pill-label">Spotify links</span>
              <span class="pill-value" id="spotify-count">0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="connect" class="button button-primary">
          <svg class="button-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 4v16m8-8H4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
          Connect to Feed
        </button>
        <button id="disconnect" class="button button-danger" disabled>
          <svg class="button-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
          Disconnect
        </button>
        <button id="clear" class="button button-secondary">
          <svg class="button-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 7l-3 13H8L5 7M20 7H4m5-3h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
          Clear All
        </button>
      </div>

      <div id="spotify-grid" class="spotify-grid">
        <div class="empty-state glass">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
                stroke="currentColor"
                stroke-width="2"
              />
              <path d="M8 12h8m-4-4v8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
          </div>
          <p>Connect to start discovering music shared on Bluesky</p>
        </div>
      </div>

      <!-- Player Container -->
      <div id="player-container" class="player-container glass">
        <div id="spotify-player" class="player-content"></div>
      </div>
    </div>

    <script>
      let ws = null;
      let postsScanned = 0;
      let spotifyFound = 0;
      const MAX_PLAYERS = 50;
      let currentlyPlayingId = null;

      const connectBtn = document.getElementById("connect");
      const disconnectBtn = document.getElementById("disconnect");
      const clearBtn = document.getElementById("clear");
      const statusDiv = document.querySelector(".status");
      const spotifyGrid = document.getElementById("spotify-grid");
      const postCountSpan = document.getElementById("post-count");
      const spotifyCountSpan = document.getElementById("spotify-count");
      const playerContainer = document.getElementById("player-container");
      const spotifyPlayer = document.getElementById("spotify-player");

      function updateStatus(connected) {
        statusDiv.classList.toggle("connected", connected);
        statusDiv.querySelector(".status-text").textContent = connected ? "Connected" : "Not Connected";
        connectBtn.disabled = connected;
        disconnectBtn.disabled = !connected;
      }

      function updateStats() {
        postCountSpan.textContent = postsScanned;
        spotifyCountSpan.textContent = spotifyFound;
      }

      function extractSpotifyInfo(url) {
        const patterns = [
          /open\.spotify\.com\/(track|album|playlist|artist)\/([a-zA-Z0-9]+)/,
          /spotify:(track|album|playlist|artist):([a-zA-Z0-9]+)/,
        ];

        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match) {
            return {
              type: match[1],
              id: match[2],
            };
          }
        }
        return null;
      }

      function getBadgeIcon(type) {
        switch (type) {
          case "track":
            return '<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M12 8v4l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>';
          case "album":
            return '<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M12 12c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z" stroke="currentColor" stroke-width="2"/>';
          case "playlist":
            return '<path d="M16 17H5M16 12H5M16 7H5M19 17h2M19 12h2M19 7h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>';
          default:
            return '<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke="currentColor" stroke-width="2"/>';
        }
      }

      function playTrack(spotifyId, type, cardElement) {
        // Remove playing state from previous card
        const previousCard = document.querySelector(".spotify-card.playing");
        if (previousCard) {
          previousCard.classList.remove("playing");
        }

        // Add playing state to current card
        cardElement.classList.add("playing");

        // Update player with autoplay enabled
        spotifyPlayer.innerHTML = `
          <iframe
            src="https://open.spotify.com/embed/${type}/${spotifyId}?autoplay=1"
            frameborder="0"
            allowtransparency="true"
            allow="encrypted-media; autoplay"
          ></iframe>
        `;

        currentlyPlayingId = spotifyId;
        playerContainer.classList.add("visible");
      }

      async function getSpotifyArtwork(type, id) {
        try {
          const response = await fetch(`https://open.spotify.com/oembed?url=spotify:${type}:${id}`);
          const data = await response.json();
          return data.thumbnail_url;
        } catch (error) {
          console.error("Error fetching artwork:", error);
          return null;
        }
      }

      async function addSpotifyCard(spotifyInfo, postUrl) {
        if (spotifyFound === 0) {
          spotifyGrid.innerHTML = "";
        }

        if (spotifyFound >= MAX_PLAYERS) {
          const oldestCard = spotifyGrid.lastChild;
          if (oldestCard) {
            spotifyGrid.removeChild(oldestCard);
          }
        }

        // Get artwork URL
        const artworkUrl = await getSpotifyArtwork(spotifyInfo.type, spotifyInfo.id);

        const card = document.createElement("div");
        card.className = "spotify-card glass";
        card.setAttribute("data-spotify-id", spotifyInfo.id);
        card.setAttribute("data-spotify-type", spotifyInfo.type);

        card.innerHTML = `
          <div class="spotify-preview">
            <div class="preview-image">
              <img src="${artworkUrl || "/placeholder.png"}" alt="Album Art" loading="lazy" />
            </div>
            <button class="play-button glass" aria-label="Play Preview">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 5v14l11-7-11-7z" fill="currentColor"/>
              </svg>
              <div class="button-glow"></div>
            </button>
          </div>
          <div class="card-content">
            <div class="card-badges">
              <span class="type-badge ${spotifyInfo.type}-badge">
                <svg class="badge-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  ${getBadgeIcon(spotifyInfo.type)}
                </svg>
                ${spotifyInfo.type}
              </span>
            </div>
            <a href="${postUrl}" target="_blank" rel="noopener noreferrer" class="post-link">
              <svg class="link-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6m4-3h6v6m-11 5L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              View original post
            </a>
          </div>
        `;

        // Add click handler for play button
        const playButton = card.querySelector(".play-button");
        playButton.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          playTrack(spotifyInfo.id, spotifyInfo.type, card);
        });

        spotifyGrid.insertBefore(card, spotifyGrid.firstChild);
        spotifyFound++;
        updateStats();
      }

      function connect() {
        if (ws) return;

        try {
          ws = new WebSocket("wss://jetstream2.us-east.bsky.network/subscribe?wantedCollections=app.bsky.feed.post");

          ws.onopen = () => {
            console.log("Connected to Bluesky WebSocket");
            updateStatus(true);
          };

          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              postsScanned++;
              updateStats();

              if (data.commit?.operation !== "create" || data.commit?.collection !== "app.bsky.feed.post") {
                return;
              }

              const record = data.commit.record;
              if (!record) return;

              const postUrl = `https://bsky.app/profile/${data.did}/post/${data.commit.rkey}`;
              let spotifyInfo = null;

              if (record.embed?.$type === "app.bsky.embed.external") {
                const embedUrl = record.embed.external.uri;
                if (embedUrl) {
                  spotifyInfo = extractSpotifyInfo(embedUrl);
                }
              }

              if (!spotifyInfo && record.facets) {
                for (const facet of record.facets) {
                  const link = facet.features?.find((f) => f.$type === "app.bsky.richtext.facet#link");
                  if (link?.uri) {
                    spotifyInfo = extractSpotifyInfo(link.uri);
                    if (spotifyInfo) break;
                  }
                }
              }

              if (!spotifyInfo && record.text) {
                spotifyInfo = extractSpotifyInfo(record.text);
              }

              if (spotifyInfo) {
                addSpotifyCard(spotifyInfo, postUrl);
              }
            } catch (e) {
              console.error("Error processing message:", e);
            }
          };

          ws.onerror = (error) => {
            console.error("WebSocket Error:", error);
            updateStatus(false);
          };

          ws.onclose = () => {
            console.log("Disconnected from Bluesky WebSocket");
            ws = null;
            updateStatus(false);
          };
        } catch (error) {
          console.error("Connection Error:", error);
          ws = null;
          updateStatus(false);
        }
      }

      async function getSpotifyArtwork(type, id) {
        try {
          const response = await fetch(`https://open.spotify.com/oembed?url=spotify:${type}:${id}`);
          const data = await response.json();
          return data.thumbnail_url;
        } catch (error) {
          console.error("Error fetching artwork:", error);
          return null;
        }
      }

      async function addSpotifyCard(spotifyInfo, postUrl) {
        if (spotifyFound === 0) {
          spotifyGrid.innerHTML = "";
        }

        if (spotifyFound >= MAX_PLAYERS) {
          const oldestCard = spotifyGrid.lastChild;
          if (oldestCard) {
            spotifyGrid.removeChild(oldestCard);
          }
        }

        const artworkUrl = await getSpotifyArtwork(spotifyInfo.type, spotifyInfo.id);

        const card = document.createElement("div");
        card.className = "spotify-card glass";
        card.setAttribute("data-spotify-id", spotifyInfo.id);
        card.setAttribute("data-spotify-type", spotifyInfo.type);

        card.innerHTML = `
    <div class="spotify-preview">
      <div class="preview-image">
        <img src="${artworkUrl || "/placeholder.png"}" alt="Album Art" loading="lazy" />
      </div>
      <button class="play-button glass" aria-label="Play Preview">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 5v14l11-7-11-7z" fill="currentColor"/>
        </svg>
        <div class="button-glow"></div>
      </button>
    </div>
    <div class="card-content">
      <div class="card-badges">
        <span class="type-badge ${spotifyInfo.type}-badge">
          <svg class="badge-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            ${getBadgeIcon(spotifyInfo.type)}
          </svg>
          ${spotifyInfo.type}
        </span>
      </div>
      <a href="${postUrl}" target="_blank" rel="noopener noreferrer" class="post-link">
        <svg class="link-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6m4-3h6v6m-11 5L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        View original post
      </a>
    </div>
  `;

        // Add click handler for play button
        const playButton = card.querySelector(".play-button");
        playButton.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          playTrack(spotifyInfo.id, spotifyInfo.type, card);
        });

        spotifyGrid.insertBefore(card, spotifyGrid.firstChild);
        spotifyFound++;
        updateStats();
      }

      function getBadgeIcon(type) {
        switch (type) {
          case "track":
            return '<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M12 8v4l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>';
          case "album":
            return '<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M12 12c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z" stroke="currentColor" stroke-width="2"/>';
          case "playlist":
            return '<path d="M16 17H5M16 12H5M16 7H5M19 17h2M19 12h2M19 7h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>';
          default:
            return '<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke="currentColor" stroke-width="2"/>';
        }
      }

      function playTrack(spotifyId, type, cardElement) {
        // Remove playing state from previous card
        const previousCard = document.querySelector(".spotify-card.playing");
        if (previousCard) {
          previousCard.classList.remove("playing");
        }

        // Add playing state to current card
        cardElement.classList.add("playing");

        // Update player with autoplay enabled
        spotifyPlayer.innerHTML = `
    <iframe
      src="https://open.spotify.com/embed/${type}/${spotifyId}?autoplay=1"
      frameborder="0"
      allowtransparency="true"
      allow="encrypted-media; autoplay"
    ></iframe>
  `;

        currentlyPlayingId = spotifyId;
        playerContainer.classList.add("visible");
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
          updateStatus(false);
        }
      }

      function clearPlayers() {
        spotifyGrid.innerHTML = `
    <div class="empty-state glass">
      <div class="empty-icon">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke="currentColor" stroke-width="2"/>
          <path d="M8 12h8m-4-4v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <p>Connect to start discovering music shared on Bluesky</p>
    </div>
  `;
        spotifyFound = 0;
        currentlyPlayingId = null;
        spotifyPlayer.innerHTML = "";
        playerContainer.classList.remove("visible");
        updateStats();
      }

      connectBtn.addEventListener("click", connect);
      disconnectBtn.addEventListener("click", disconnect);
      clearBtn.addEventListener("click", clearPlayers);
    </script>
  </body>
</html>
